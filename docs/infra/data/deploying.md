# Deploying a Data Provider

## Background

Providing data to the FTSO system includes you in the decentralized oracle system.
FTSO data providers submit data to on-chain contracts deployed on the Flare and Songbird networks.
Data providers interact primarily with the `Price Submitter` and `FTSO` contracts.
All the relevant contracts for the FTSO system are available in the smart contract repository (see the [Developer Docs](../../dev/index.md) section).
These contracts are deployed and verified on the [Block explorer](../../user/block-explorer.md).

## Prerequisites

To operate a data provider you need to be familiar with:

* Smart contracts and Solidity.
* Interacting with smart contract using a web3 library.
* The Hardhat runtime environment.

## First steps

To quickly get started, use the kick-off NPM package [referenced here](../../dev/index.md).
This package showcases the main contracts related to whitelisting a data provider and submitting data.
It also enables you to deploy FTSO mock contracts in a local setup and submit data to those contracts.
Working with the package should help all setup stages for your data provider.

Working with this package is mostly identical to providing data on-chain.
The following aspects would be the same as or similar to working on-chain:

* Smart contract APIs (called functions).
* Events.
* Timing aspects are similar but not identical.

The package does not cover the actual data calculation (weighted median) and rewarding as they occur on the real network.

Please visit the [Developer Docs](../../dev/index.md) section to find a link to a reference implementation of a data provider.
This code contains useful information that will help you interact with the FTSO contracts and the Flare chain.
If you want to earn rewards, you must do additional work on top of this implementation.

### Providing random numbers

The data-providing process is structured as a commit-and-reveal scheme to prevent users from copying another user's submitted data.
The commit-and-reveal phases are restricted to only a few minutes in duration.
With each reveal the data provider also provides a random number.
The random number is used first as a salt in the commit-and-reveal scheme and later during the reward calculation process.

Data providers are encouraged to provide strong, cryptographically secure, random numbers with high entropy and sufficient range.
Strong random numbers are important for network security because they are the only true source of randomness on the network.
Random numbers also make the commit-and-reveal scheme resilient to attacks.
Random numbers below 2^128^ are considered unsafe and are rejected on reveal.

## Going live

When you feel comfortable with the local NPM package, you are ready to start submitting your data on-chain.

To run on the real network you will face some new challenges:

* **Gain vote power**: Data providers can whitelist themselves as providers only if they have enough vote power.
* **Observation node**: It is recommended that each data provider runs an observation node.
* **Timing issues**: You will face two challenges:
    * Align with the on-chain time data. The on-chain timestamp might skew up to 30 - 40 seconds from the real-world time.
    * Determine when to submit your data. If you submit it too late, the transaction might not get included. If you submit it too early, the data might not be accurate enough.
* **Claim rewards**: Be sure to claim your reward regularly and wrap them so you earn more vote power.

## Notes

* On the real network `PriceSubmitter` is deployed at the fixed address `0x1000000000000000000000000000000000000003`.

## FAQ

### What can I do to generate strong random numbers?

Use already available random number generators that provide a cryptographically secure (pseudo) random number.
One good example would be the `csprng` library for `nodejs` applications.
Remember that you can submit randoms with 256 bits so try to use all the bits for entropy.
Strong random numbers can also be generated by using Web3 utils: `web3.utils.toBN(web3.utils.randomHex(32))`

### How do I calculate hash for the commit-and-reveal scheme?

The full and up-to-date specification for the commit-and-reveal scheme is available in specifications in the Flare [smart contract repository](https://gitlab.com/flarenetwork/flare-smart-contracts/-/blob/master/docs/specs/PriceProvider.md).

The following code snippets demonstrate how hashes can be generated in Typescript and Python using publicly available Web3 libraries:

=== "Typescript"

     ```typescript
     import BN from "bn.js";
     import {
         BigNumber
     } from "ethers";
     import {
         ethers
     } from "hardhat";
     const MIN_RANDOM = web3.utils.toBN(2).pow(web3.utils.toBN(128));

     function submitHash(ftsoIndices: (number | BN | BigNumber)[],
         prices: (number | BN | BigNumber)[],
         random: number | BN | BigNumber,
         address: string): string {

         return ethers.utils.keccak256(web3.eth.abi.encodeParameters(
             ["uint256[]", "uint256[]", "uint256", "address"],
             [ftsoIndices, prices, random, address]));
     }
     const ftsoIndices = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
     const randoms = [MIN_RANDOM, MIN_RANDOM.addn(5), MIN_RANDOM.addn(1059),
         MIN_RANDOM.addn(10682), MIN_RANDOM.addn(159726)
     ];
     const prices = [0, 1, 2, 3, 5, 10, 50, 100, 101, 10 ** 5 + 1, 10 ** 8];
     const addrs = [accounts[10], accounts[11], accounts[12], accounts[13]];

     console.log(`Prices: ${prices}`);
     for(let addr of addrs) {
         console.log(`Address: ${addr}`);
         for(let random of randoms) {
             console.log(`\tRandom: ${random}`)
             const hash = submitHash(ftsoIndices, prices, random, addr);
             console.log(`\t\t${hash}`);
         }
     }
     ```

===  "Python"

     ```python
     from typing import List
     from web3 import Web3
     import eth_abi

     minimal_random = 2 ** 128

     def submit_price_hash(
         ftsoIndices: List[int], prices: List[int], random: int, address: str
     ) -> str:
         assert len(ftsoIndices) == len(prices)
         assert list(sorted(ftsoIndices)) == ftsoIndices and len(
             set(ftsoIndices)
         ) == len(ftsoIndices), "Indices are non increasing"
         return Web3.keccak(
             eth_abi.encode_abi(
                 ["uint256[]", "uint256[]", "uint256", "address"],
                 [ftsoIndices, prices, random, address],
             )
         ).hex()


     def test_fun(
         prices: List[int],
         random: int,
         address="0xD7de703D9BBC4602242D0f3149E5fFCD30Eb3ADF",
     ) -> List[str]:
         return submit_price_hash(list(range(len(prices))), prices, random, address)


     addrs = [
         "0xD7de703D9BBC4602242D0f3149E5fFCD30Eb3ADF",
         "0xEa960515F8b4C237730F028cBAcF0a28E7F45dE0",
         "0x3d91185a02774C70287F6c74Dd26d13DFB58ff16",
     ]
     prices = [0, 1, 2, 3, 5, 10, 50, 100, 101, 10 ** 5 + 1, 10 ** 8]
     randoms = [
          min_random + r for r in
          [0, 1, 100, 101, 100000000000000000000]
     ]
     for addr in addrs:
         print(f"Address: {addr}")
         for rand in randoms:
             print(f"  Random: {rand}")
             print("    hash:", test_fun(prices, rand, addr))
         print()
     ```

### Where can I find the contracts I need to interact with as a data provider?

The `PriceSubmitter` contract is deployed at the fixed address `0x1000000000000000000000000000000000000003`.
All the other contracts are available as read methods on the `PriceSubmitter` contract.
Periodically check for updates to have up to date information.
Any important updates and contract changes will be broadcasted to the community.

### Where can I browse the source code and documentation for contracts?

All the important contracts are verified on the [Blocks Explorer](../../user/block-explorer.md).
The main smart contract repo is referenced in the [Developer Docs](../../dev/index.md) section.

### What are the important contracts I need to be aware of to be a data provider?

The most important contract is the `PriceSubmitter`, where you submit data. It also has links to the following contracts:

* `FtsoRegistry`: Holds information about specific FTSOs, their symbols, indices and addresses.
* `FTSOManager`: Holds epoch and voting-related configuration data and oversees all FTSOs.
  It also gives access to additional useful contracts, such as the `Inflation` and `Supply` contracts.
* `VoterWhitelister`: The contract where data providers list themselves to submit data.

### How much does it cost to submit data as a data provider?

Data submissions and reveals are currently discounted on Songbird. If all the submission and reveal transactions are successful, the cost is approximately 3 - 4 SGB per day.

### Where can I see the FTSOs for which I am eligible to submit prices?

Each address is whitelisted separately for each FTSO contract.
Query whitelisting data through the `VoterWhitelister` contract or the `PriceSubmitter` contract.

### How can I read whitelisted addresses using the `VoterWhitelister` contract?

Each FTSO contains an array of whitelisted addresses.
Open an FTSO contract and use the method `getFtsoWhitelistedPriceProviders`.
Set the required index and check whether your address is in this list.

### How can I read whitelisted addresses using the `PriceSubmitter` contract?

Open the contract and use the method `voterWhitelistBitmap` to set the address you want to query.
The function returns a bitmap corresponding to allowed FTSO indices in big-endian format. If you were allowed to submit princess for FTSOs with indices 0, 1 and 3, the returned bitmap would be 11 (`1011` in binary).

### Which currencies are available on the network?

To get available currencies, query `FtsoRegistry`, which holds information about available FTSOs, their addresses, data, and indices.
Songbird currently supports the following symbols: `XRP, LTC, XLM, DOGE, ADA, ALGO, BCH, DGB, BTC, ETH, FIL, SGB`. New symbols can be added by a governance vote.

The Flare network will start with the same symbols that Songbird supports.

### Do data providers that are unavailable get slashed?

Unavailable data providers don't get slashed, but if they don't provide data in a specific epoch, they do not earn rewards in that epoch.

### The network time is not the same as local time. Is something wrong?

Due to the decentralized state of the network, you might experience some occasional time drifts (+-30s).
We suggest you keep synchronized local time with global time through the Network Time Protocol (NTP) to avoid missing any submit/reveal periods.

### Where can I get information about which data is rewarded?

Each FTSO emits a `PriceFinalized` event that contains information about calculated median data and rewarding bounds.

### How can I see who has delegated to me?

Currently no on-chain structure holds this data. Consider listening to events emitted by delegations.

### The NPM library is written in Typescript. Can I use another language to write a data provider?

Yes, you can use any language to run the data provider, although some languages might be better than others.
Try using a language that offers good support for Ethereum smart contracts, e.g. `web3-your-language`.
Many successful data providers use different technologies, such as go, C#, or python.

### Is there any code for writing a data provider in Python?

This [gist](https://gist.github.com/jO-Osko/a9e8904cb3e8f9af5f154302117b4444) showcases the calculation of submit hashes in Python using the `web3py` library.

### Are delegations transferable between different addresses?

Delegations are currently not transferable. Specifically, you can't redelegate the vote power that was delegated to your address.

### Does the price epoch vary with each FTSO?

No, price epoch configurations are governed by the `FtsoManager` contract. You can get them using the `getPriceEpochConfiguration` method.
This governance is necessary so that all submissions and reveals can happen at the same time.

### Can price epoch duration change?

Price epoch durations are generally fixed and will not change abruptly.
Any such change will be broadcasted to the community and be part of a governance decision.

### Why am I getting strange reverts on submission?

One reason could be related to the status of your node. Ensure the node is healthy and has enough peers. See [Troubleshooting](./troubleshooting.md).
